<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Intake Assistant | Psychezone International</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-soul: #5D3FD3;
            --calm-mind: #6AC0C0;
            --hope-glow: #FF9A76;
            --dark-sanctuary: #0A0A1A;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--dark-sanctuary);
            color: white;
            min-height: 100vh;
        }

        /* Header */
        header {
            background: rgba(10, 10, 26, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 5%;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .logo-icon { font-size: 2rem; color: var(--primary-soul); }
        .logo-text {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(to right, var(--primary-soul), var(--calm-mind));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* Navigation Links */
        .nav-links {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1.2rem;
            border-radius: 30px;
            transition: var(--transition);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-link:hover {
            background: rgba(93, 63, 211, 0.2);
            transform: translateY(-2px);
        }

        .back-btn {
            background: rgba(93, 63, 211, 0.2);
            border: 2px solid var(--primary-soul);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .back-btn:hover {
            background: rgba(93, 63, 211, 0.4);
            transform: translateX(-5px);
        }

        /* AI Chat Container */
        .ai-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .ai-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(93, 63, 211, 0.1), rgba(106, 192, 192, 0.1));
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ai-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-soul), var(--calm-mind));
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .ai-disclaimer {
            background: rgba(255, 154, 118, 0.1);
            border-left: 4px solid var(--hope-glow);
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Chat Interface */
        .chat-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            height: 500px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            max-width: 85%;
            padding: 1rem 1.5rem;
            border-radius: 20px;
            animation: slideIn 0.3s ease;
            position: relative;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ai-message {
            background: rgba(93, 63, 211, 0.2);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .user-message {
            background: rgba(106, 192, 192, 0.2);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        /* Language Selector */
        .language-selector {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            justify-content: center;
        }

        .lang-btn {
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            color: white;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .lang-btn.active {
            background: rgba(93, 63, 211, 0.3);
            border-color: var(--primary-soul);
        }

        .lang-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Quick Options */
        .quick-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .quick-option {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .quick-option:hover {
            background: rgba(93, 63, 211, 0.2);
            transform: translateY(-3px);
            border-color: var(--primary-soul);
        }

        /* Chat Input */
        .chat-input-area {
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 1rem;
            background: rgba(10, 10, 26, 0.8);
        }

        .chat-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            padding: 1rem 1.5rem;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: var(--transition);
        }

        .chat-input:focus {
            border-color: var(--primary-soul);
            background: rgba(255, 255, 255, 0.15);
        }

        .send-btn {
            background: linear-gradient(45deg, var(--primary-soul), #7B5FE8);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(93, 63, 211, 0.5);
        }

        /* Voice Input */
        .voice-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-top: 1rem;
        }

        .voice-btn {
            background: rgba(255, 154, 118, 0.2);
            border: 2px solid var(--hope-glow);
            color: var(--hope-glow);
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .voice-btn.listening {
            animation: pulse 1s infinite;
            background: rgba(255, 154, 118, 0.4);
        }

        /* Progress */
        .intake-progress {
            margin: 2rem 0;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin: 2rem 0;
        }

        .progress-steps:before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 1;
        }

        .progress-step {
            position: relative;
            z-index: 2;
            text-align: center;
            flex: 1;
        }

        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            margin: 0 auto 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: var(--transition);
        }

        .step-circle.active {
            background: var(--primary-soul);
            transform: scale(1.2);
        }

        .step-circle.completed {
            background: var(--calm-mind);
        }

        /* Results */
        .results-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 2rem;
            margin-top: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }

        .recommendation-card {
            background: rgba(93, 63, 211, 0.1);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid var(--primary-soul);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 0 2rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary-soul);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Navigation Footer */
        .nav-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .footer-links {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .footer-link {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.05);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .footer-link:hover {
            background: rgba(93, 63, 211, 0.2);
            color: white;
            transform: translateY(-2px);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .chat-container {
                height: 400px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .quick-options {
                grid-template-columns: 1fr;
            }
            
            .language-selector {
                flex-direction: column;
                align-items: center;
            }
            
            .nav-links {
                display: none;
            }
            
            .mobile-menu {
                display: flex;
                align-items: center;
                gap: 1rem;
            }
            
            .nav-footer {
                flex-direction: column;
            }
        }

        /* Mobile Menu Button */
        .menu-btn {
            display: none;
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .menu-btn {
                display: block;
            }
            
            .nav-links {
                position: fixed;
                top: 80px;
                left: 0;
                right: 0;
                background: rgba(10, 10, 26, 0.98);
                backdrop-filter: blur(10px);
                flex-direction: column;
                padding: 2rem;
                display: none;
                z-index: 999;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .nav-links.active {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <!-- Header with Navigation -->
    <header>
        <div class="nav-container">
            <a href="index.html" class="logo">
                <i class="fas fa-brain logo-icon"></i>
                <div class="logo-text">PSYCHEZONE</div>
            </a>
            
            <button class="menu-btn" id="menuBtn">
                <i class="fas fa-bars"></i>
            </button>
            
            <nav class="nav-links" id="navLinks">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i> Home
                </a>
                <a href="dashboard.html" class="nav-link">
                    <i class="fas fa-chart-line"></i> Dashboard
                </a>
                <a href="therapies.html" class="nav-link">
                    <i class="fas fa-heartbeat"></i> Therapies
                </a>
                <a href="voice-tools.html" class="nav-link">
                    <i class="fas fa-microphone-alt"></i> Voice Tools
                </a>
                <button class="back-btn" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
            </nav>
        </div>
    </header>

    <main class="ai-container">
        <div class="ai-header">
            <div class="ai-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <h1>AI Intake Assistant</h1>
            <p>Gentle, confidential conversation to understand your needs</p>
            
            <div class="ai-disclaimer">
                <i class="fas fa-exclamation-circle"></i>
                This AI assistant does NOT provide diagnosis or treatment. 
                It helps match you with appropriate services and professionals.
            </div>
        </div>

        <!-- Language Selector -->
        <div class="language-selector">
            <button class="lang-btn active" id="englishBtn">
                <i class="fas fa-language"></i> English
            </button>
            <button class="lang-btn" id="swahiliBtn">
                <i class="fas fa-language"></i> Kiswahili
            </button>
        </div>

        <!-- Progress Tracker -->
        <div class="intake-progress">
            <div class="progress-steps">
                <div class="progress-step">
                    <div class="step-circle active" id="step1">1</div>
                    <div style="font-size: 0.8rem;">Welcome</div>
                </div>
                <div class="progress-step">
                    <div class="step-circle" id="step2">2</div>
                    <div style="font-size: 0.8rem;">How You Feel</div>
                </div>
                <div class="progress-step">
                    <div class="step-circle" id="step3">3</div>
                    <div style="font-size: 0.8rem;">Background</div>
                </div>
                <div class="progress-step">
                    <div class="step-circle" id="step4">4</div>
                    <div style="font-size: 0.8rem;">Goals</div>
                </div>
                <div class="progress-step">
                    <div class="step-circle" id="step5">5</div>
                    <div style="font-size: 0.8rem;">Recommendations</div>
                </div>
            </div>
        </div>

        <!-- Chat Interface -->
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <!-- Initial AI message will be added by JavaScript -->
            </div>

            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <span style="color: rgba(255,255,255,0.7); margin-left: 0.5rem;">AI is typing...</span>
            </div>

            <div class="chat-input-area">
                <input type="text" class="chat-input" id="messageInput" placeholder="Type your message..." autocomplete="off">
                <button class="send-btn" id="sendBtn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <!-- Quick Response Options -->
        <div class="quick-options" id="quickOptions">
            <!-- Quick options will be dynamically generated -->
        </div>

        <!-- Voice Controls -->
        <div class="voice-controls">
            <button class="voice-btn" id="voiceBtn">
                <i class="fas fa-microphone"></i>
                Speak Instead
            </button>
            <div id="voiceStatus" style="color: var(--calm-mind); font-size: 0.9rem;">
                Click to start speaking
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <h3 style="color: var(--calm-mind); margin-bottom: 1rem;">
                <i class="fas fa-clipboard-check"></i> Your Personalized Recommendations
            </h3>
            
            <div class="recommendation-card">
                <h4>üíÜ Cognitive Behavioral Therapy (CBT)</h4>
                <p id="cbtRecommendation">Based on your conversation, CBT could help you manage thought patterns and develop coping strategies.</p>
                <a href="therapies.html" style="color: var(--primary-soul); text-decoration: none;">
                    Learn more about CBT ‚Üí
                </a>
            </div>

            <div class="recommendation-card">
                <h4>ü§ù Therapist Match</h4>
                <p id="therapistMatch">We've found therapists who specialize in your specific needs and speak your preferred language.</p>
                <a href="therapist-match.html" style="color: var(--primary-soul); text-decoration: none;">
                    View matches ‚Üí
                </a>
            </div>

            <div class="recommendation-card">
                <h4>üéß Immediate Support</h4>
                <p id="immediateSupport">Try our guided breathing exercises while you wait for your first session.</p>
                <a href="voice-tools.html" style="color: var(--primary-soul); text-decoration: none;">
                    Start breathing exercise ‚Üí
                </a>
            </div>

            <div style="margin-top: 2rem; text-align: center;">
                <a href="contact.html" style="display: inline-block; background: linear-gradient(45deg, var(--primary-soul), #7B5FE8); 
                   color: white; padding: 1rem 2rem; border-radius: 25px; text-decoration: none; font-weight: bold;">
                    Book Your First Session
                </a>
            </div>
        </div>

        <!-- Navigation Footer -->
        <div class="nav-footer">
            <div class="footer-links">
                <a href="index.html" class="footer-link">
                    <i class="fas fa-home"></i> Home
                </a>
                <a href="dashboard.html" class="footer-link">
                    <i class="fas fa-chart-line"></i> Dashboard
                </a>
                <a href="therapies.html" class="footer-link">
                    <i class="fas fa-heartbeat"></i> All Therapies
                </a>
                <a href="workshops.html" class="footer-link">
                    <i class="fas fa-users"></i> Workshops
                </a>
                <a href="confessional.html" class="footer-link">
                    <i class="fas fa-user-secret"></i> Anonymous Release
                </a>
            </div>
            
            <button class="back-btn" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> Back to Previous Page
            </button>
        </div>
    </main>

    <script>
        // ================== NAVIGATION FUNCTIONS ==================
        function goBack() {
            // Check if there's a previous page in history
            if (window.history.length > 1) {
                window.history.back();
            } else {
                // Default to homepage if no history
                window.location.href = 'index.html';
            }
        }

        // Mobile menu toggle
        document.getElementById('menuBtn').addEventListener('click', function() {
            document.getElementById('navLinks').classList.toggle('active');
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const navLinks = document.getElementById('navLinks');
            const menuBtn = document.getElementById('menuBtn');
            
            if (!navLinks.contains(event.target) && !menuBtn.contains(event.target)) {
                navLinks.classList.remove('active');
            }
        });

        // ================== CONFIGURATION ==================
        const CONFIG = {
            currentStep: 1,
            selectedLanguage: 'english',
            userAnswers: {},
            conversationHistory: [],
            isProcessing: false
        };

        // English conversation flow
        const ENGLISH_FLOW = {
            welcome: {
                question: "Hello! I'm here to help you find the right mental health support. This conversation is completely confidential. What language would you prefer for our conversation?",
                quickOptions: [
                    { text: "English", value: "english" },
                    { text: "Kiswahili", value: "swahili" },
                    { text: "Both languages", value: "both" }
                ]
            },
            feelings: {
                question: "Thank you. How have you been feeling recently?",
                quickOptions: [
                    { text: "Anxious or stressed", value: "anxious" },
                    { text: "Sad or depressed", value: "sad" },
                    { text: "Overwhelmed", value: "overwhelmed" },
                    { text: "Angry or irritable", value: "angry" },
                    { text: "Lonely", value: "lonely" },
                    { text: "Just need someone to talk to", value: "talk" }
                ]
            },
            duration: {
                question: "How long have you been feeling this way?",
                quickOptions: [
                    { text: "A few days", value: "days" },
                    { text: "A few weeks", value: "weeks" },
                    { text: "Several months", value: "months" },
                    { text: "More than a year", value: "year" }
                ]
            },
            support: {
                question: "Have you spoken to anyone about how you're feeling?",
                quickOptions: [
                    { text: "Yes, friends or family", value: "friends" },
                    { text: "Yes, a professional", value: "professional" },
                    { text: "No, I haven't told anyone", value: "no_one" },
                    { text: "Not yet, but I want to", value: "want_to" }
                ]
            },
            goals: {
                question: "What would you like to achieve through therapy?",
                quickOptions: [
                    { text: "Reduce anxiety", value: "reduce_anxiety" },
                    { text: "Improve sleep", value: "sleep" },
                    { text: "Better relationships", value: "relationships" },
                    { text: "Coping skills", value: "coping" },
                    { text: "Self-understanding", value: "understanding" },
                    { text: "Not sure yet", value: "unsure" }
                ]
            },
            preferences: {
                question: "What are your preferences for therapy?",
                quickOptions: [
                    { text: "In-person sessions", value: "in_person" },
                    { text: "Online therapy", value: "online" },
                    { text: "Either works", value: "either" },
                    { text: "Group workshops", value: "group" },
                    { text: "Male therapist", value: "male_therapist" },
                    { text: "Female therapist", value: "female_therapist" }
                ]
            }
        };

        // Swahili conversation flow
        const SWAHILI_FLOW = {
            welcome: {
                question: "Hujambo! Mimi ni hapa kukusaidia kupata usaidizi unaofaa kwa afya ya akili. Mazungumzo haya ni ya siri kabisa. Ungependa lugha gani kwa mazungumzo yetu?",
                quickOptions: [
                    { text: "Kiingereza", value: "english" },
                    { text: "Kiswahili", value: "swahili" },
                    { text: "Lugha zote mbili", value: "both" }
                ]
            },
            feelings: {
                question: "Asante. Umekuwa ukihisi vipi hivi karibuni?",
                quickOptions: [
                    { text: "Wasiwasi au mkazo", value: "anxious" },
                    { text: "Huzuni au unyogovu", value: "sad" },
                    { text: "Kuzidiwa", value: "overwhelmed" },
                    { text: "Hasira", value: "angry" },
                    { text: "Upweke", value: "lonely" },
                    { text: "Nahitaji tu mtu wa kuongea naye", value: "talk" }
                ]
            },
            duration: {
                question: "Umekuwa ukihisi hivi kwa muda gani?",
                quickOptions: [
                    { text: "Siku chache", value: "days" },
                    { text: "Wiki chache", value: "weeks" },
                    { text: "Miezi kadhaa", value: "months" },
                    { text: "Zaidi ya mwaka", value: "year" }
                ]
            },
            support: {
                question: "Umeongea na mtu yeyote kuhusu unavyohisi?",
                quickOptions: [
                    { text: "Ndiyo, marafiki au familia", value: "friends" },
                    { text: "Ndiyo, mtaalamu", value: "professional" },
                    { text: "Hapana, sijawaambia mtu yeyote", value: "no_one" },
                    { text: "Bado, lakini nataka", value: "want_to" }
                ]
            },
            goals: {
                question: "Ungependa kufikia nini kupitia tiba?",
                quickOptions: [
                    { text: "Kupunguza wasiwasi", value: "reduce_anxiety" },
                    { text: "Kuboresha usingizi", value: "sleep" },
                    { text: "Uhusiano bora", value: "relationships" },
                    { text: "Ujuzi wa kukabiliana", value: "coping" },
                    { text: "Kujielewa", value: "understanding" },
                    { text: "Sijui bado", value: "unsure" }
                ]
            },
            preferences: {
                question: "Ni upendeleo gani unao kuhusu tiba?",
                quickOptions: [
                    { text: "Mikutano ya uso kwa uso", value: "in_person" },
                    { text: "Tiba mtandaoni", value: "online" },
                    { text: "Yoyote inafaa", value: "either" },
                    { text: "Warsha za kikundi", value: "group" },
                    { text: "Mtaalamu wa kiume", value: "male_therapist" },
                    { text: "Mtaalamu wa kike", value: "female_therapist" }
                ]
            }
        };

        // ================== DOM ELEMENTS ==================
        const elements = {
            chatMessages: document.getElementById('chatMessages'),
            messageInput: document.getElementById('messageInput'),
            sendBtn: document.getElementById('sendBtn'),
            voiceBtn: document.getElementById('voiceBtn'),
            voiceStatus: document.getElementById('voiceStatus'),
            resultsSection: document.getElementById('resultsSection'),
            quickOptions: document.getElementById('quickOptions'),
            englishBtn: document.getElementById('englishBtn'),
            swahiliBtn: document.getElementById('swahiliBtn'),
            typingIndicator: document.getElementById('typingIndicator'),
            step1: document.getElementById('step1'),
            step2: document.getElementById('step2'),
            step3: document.getElementById('step3'),
            step4: document.getElementById('step4'),
            step5: document.getElementById('step5')
        };

        // ================== INITIALIZATION ==================
        function init() {
            // Set up event listeners
            elements.sendBtn.addEventListener('click', sendMessage);
            elements.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !CONFIG.isProcessing) {
                    sendMessage();
                }
            });

            elements.voiceBtn.addEventListener('click', toggleVoiceInput);
            
            // Language buttons
            elements.englishBtn.addEventListener('click', () => setLanguage('english'));
            elements.swahiliBtn.addEventListener('click', () => setLanguage('swahili'));

            // Start conversation
            setTimeout(() => {
                showTypingIndicator();
                setTimeout(() => {
                    askQuestion('welcome');
                }, 1000);
            }, 500);
        }

        // ================== CORE FUNCTIONS ==================
        function setLanguage(lang) {
            CONFIG.selectedLanguage = lang;
            
            // Update UI
            elements.englishBtn.classList.toggle('active', lang === 'english');
            elements.swahiliBtn.classList.toggle('active', lang === 'swahili');
            
            // Clear and restart conversation
            clearChat();
            CONFIG.currentStep = 1;
            updateProgressSteps();
            
            showTypingIndicator();
            setTimeout(() => {
                askQuestion('welcome');
            }, 1000);
        }

        function askQuestion(step) {
            const flow = CONFIG.selectedLanguage === 'english' ? ENGLISH_FLOW : SWAHILI_FLOW;
            const questionData = flow[step];
            
            if (!questionData) {
                showResults();
                return;
            }
            
            addMessage('ai', questionData.question);
            
            // Clear and update quick options
            elements.quickOptions.innerHTML = '';
            questionData.quickOptions.forEach(option => {
                const optionEl = document.createElement('div');
                optionEl.className = 'quick-option';
                optionEl.textContent = option.text;
                optionEl.setAttribute('data-value', option.value);
                optionEl.addEventListener('click', () => handleQuickOption(option.value, option.text));
                elements.quickOptions.appendChild(optionEl);
            });
        }

        function handleQuickOption(value, text) {
            if (CONFIG.isProcessing) return;
            
            // Add user's response
            addMessage('user', text);
            
            // Store answer
            const stepName = getCurrentStepName();
            CONFIG.userAnswers[stepName] = value;
            
            // Move to next step
            CONFIG.currentStep++;
            updateProgressSteps();
            
            // Get next question
            const nextStep = getNextStepName();
            
            if (nextStep) {
                showTypingIndicator();
                setTimeout(() => {
                    askQuestion(nextStep);
                }, 1000);
            } else {
                showResults();
            }
        }

        function sendMessage() {
            const message = elements.messageInput.value.trim();
            if (!message || CONFIG.isProcessing) return;
            
            // Add user message
            addMessage('user', message);
            elements.messageInput.value = '';
            
            // Store in history
            CONFIG.conversationHistory.push({ role: 'user', content: message });
            
            // Process response
            processUserMessage(message);
        }

        function processUserMessage(message) {
            CONFIG.isProcessing = true;
            showTypingIndicator();
            
            // Simple keyword-based response system
            setTimeout(() => {
                const stepName = getCurrentStepName();
                CONFIG.userAnswers[stepName] = message.toLowerCase();
                
                // Move to next step
                CONFIG.currentStep++;
                updateProgressSteps();
                
                // Get next question or show results
                const nextStep = getNextStepName();
                
                if (nextStep) {
                    setTimeout(() => {
                        askQuestion(nextStep);
                    }, 500);
                } else {
                    setTimeout(() => {
                        showResults();
                    }, 500);
                }
            }, 1500);
        }

        // ================== HELPER FUNCTIONS ==================
        function getCurrentStepName() {
            const steps = ['welcome', 'feelings', 'duration', 'support', 'goals', 'preferences'];
            return steps[CONFIG.currentStep - 1];
        }

        function getNextStepName() {
            const steps = ['welcome', 'feelings', 'duration', 'support', 'goals', 'preferences'];
            return steps[CONFIG.currentStep];
        }

        function updateProgressSteps() {
            // Reset all steps
            [elements.step1, elements.step2, elements.step3, elements.step4, elements.step5].forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < CONFIG.currentStep) {
                    step.classList.add('completed');
                } else if (index + 1 === CONFIG.currentStep) {
                    step.classList.add('active');
                }
            });
        }

        function addMessage(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.innerHTML = `
                <div class="message-header">
                    <i class="fas fa-${sender === 'ai' ? 'robot' : 'user'}" 
                       style="color: ${sender === 'ai' ? 'var(--primary-soul)' : 'var(--calm-mind)'};"></i>
                    <span>${sender === 'ai' ? 'Psychezone AI' : 'You'}</span>
                </div>
                <p>${text}</p>
            `;
            elements.chatMessages.appendChild(messageDiv);
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            
            // Add to conversation history
            if (sender === 'user') {
                CONFIG.conversationHistory.push({ role: 'user', content: text });
            }
            
            hideTypingIndicator();
        }

        function showTypingIndicator() {
            elements.typingIndicator.style.display = 'flex';
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            elements.typingIndicator.style.display = 'none';
            CONFIG.isProcessing = false;
        }

        function clearChat() {
            elements.chatMessages.innerHTML = '';
            elements.quickOptions.innerHTML = '';
            CONFIG.conversationHistory = [];
            CONFIG.userAnswers = {};
        }

        // ================== VOICE INPUT ==================
        function toggleVoiceInput() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition is not supported in your browser. Please use Chrome or Edge.');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.lang = CONFIG.selectedLanguage === 'swahili' ? 'sw-TZ' : 'en-US';
            recognition.interimResults = false;
            recognition.continuous = false;
            
            if (elements.voiceBtn.classList.contains('listening')) {
                // Stop listening
                recognition.stop();
                elements.voiceBtn.classList.remove('listening');
                elements.voiceStatus.textContent = CONFIG.selectedLanguage === 'english' 
                    ? 'Click to start speaking' 
                    : 'Bofya kuanza kuongea';
            } else {
                // Start listening
                elements.voiceBtn.classList.add('listening');
                elements.voiceStatus.textContent = CONFIG.selectedLanguage === 'english' 
                    ? 'Listening... Speak now' 
                    : 'Inasikiliza... Ongea sasa';
                elements.voiceStatus.style.color = 'var(--hope-glow)';
                
                recognition.start();
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    addMessage('user', transcript);
                    processUserMessage(transcript);
                    
                    elements.voiceBtn.classList.remove('listening');
                    elements.voiceStatus.textContent = CONFIG.selectedLanguage === 'english' 
                        ? 'Voice input complete' 
                        : 'Usemi umekamilika';
                    
                    setTimeout(() => {
                        elements.voiceStatus.textContent = CONFIG.selectedLanguage === 'english' 
                            ? 'Click to start speaking' 
                            : 'Bofya kuanza kuongea';
                        elements.voiceStatus.style.color = 'var(--calm-mind)';
                    }, 2000);
                };
                
                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    elements.voiceBtn.classList.remove('listening');
                    elements.voiceStatus.textContent = CONFIG.selectedLanguage === 'english' 
                        ? 'Error: Try again' 
                        : 'Hitilafu: Jaribu tena';
                    
                    setTimeout(() => {
                        elements.voiceStatus.textContent = CONFIG.selectedLanguage === 'english' 
                            ? 'Click to start speaking' 
                            : 'Bofya kuanza kuongea';
                        elements.voiceStatus.style.color = 'var(--calm-mind)';
                    }, 2000);
                };
                
                recognition.onend = () => {
                    elements.voiceBtn.classList.remove('listening');
                };
            }
        }

        // ================== RESULTS ==================
        function showResults() {
            // Generate personalized recommendations
            const primaryFeeling = CONFIG.userAnswers.feelings || 'anxious';
            const duration = CONFIG.userAnswers.duration || 'weeks';
            const hasSupport = CONFIG.userAnswers.support || 'no_one';
            const goals = CONFIG.userAnswers.goals || 'coping';
            
            // Update recommendation text based on user answers
            let cbtText = "Based on your conversation, CBT could help you manage thought patterns and develop coping strategies.";
            let therapistText = "We've found therapists who specialize in your specific needs and speak your preferred language.";
            let supportText = "Try our guided breathing exercises while you wait for your first session.";
            
            // Customize based on feelings
            if (primaryFeeling === 'anxious') {
                cbtText = "For anxiety management, CBT is particularly effective. It can help identify and challenge anxious thought patterns.";
                therapistText = "We recommend therapists who specialize in anxiety disorders and panic management.";
            } else if (primaryFeeling === 'sad') {
                cbtText = "For feelings of sadness, CBT can help restructure negative thought patterns and build positive activities.";
                therapistText = "Our therapists specialize in depression and mood disorders with gentle, supportive approaches.";
            }
            
            // Customize based on support level
            if (hasSupport === 'no_one') {
                supportText = "Starting with our guided exercises can help you feel more comfortable before your first therapy session.";
            }
            
            // Update the results section
            document.getElementById('cbtRecommendation').textContent = cbtText;
            document.getElementById('therapistMatch').textContent = therapistText;
            document.getElementById('immediateSupport').textContent = supportText;
            
            // Show results
            elements.resultsSection.style.display = 'block';
            elements.resultsSection.scrollIntoView({ behavior: 'smooth' });
            
            // Save intake data
            const intakeData = {
                language: CONFIG.selectedLanguage,
                answers: CONFIG.userAnswers,
                conversation: CONFIG.conversationHistory,
                timestamp: new Date().toISOString(),
                recommendations: {
                    cbt: cbtText,
                    therapist: therapistText,
                    immediate: supportText
                }
            };
            
            localStorage.setItem('aiIntakeData', JSON.stringify(intakeData));
            localStorage.setItem('userFeeling', primaryFeeling);
            
            // Show completion message
            showTypingIndicator();
            setTimeout(() => {
                const completionMessage = CONFIG.selectedLanguage === 'english' 
                    ? "Thank you for sharing with me. I've analyzed your responses and created personalized recommendations above. Remember, I'm here to help you find the right support, not to provide treatment."
                    : "Asante kwa kushiriki na mimi. Nimechambua majibu yako na kuunda mapendekezo ya kibinafsi hapo juu. Kumbuka, niko hapa kukusaidia kupata usaidizi unaofaa, si kutoa matibabu.";
                
                addMessage('ai', completionMessage);
            }, 1000);
        }

        // ================== START THE APP ==================
        document.addEventListener('DOMContentLoaded', init);

        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Notification function
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: rgba(10, 10, 26, 0.95);
                backdrop-filter: blur(10px);
                color: var(--calm-mind);
                padding: 1rem 1.5rem;
                border-radius: 15px;
                border-left: 4px solid var(--primary-soul);
                z-index: 10000;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
